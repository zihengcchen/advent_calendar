<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8" />
  <title>2025 Advent Calendar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-main: #0b1b25;
      --bg-card: rgba(255, 255, 255, 0.08);
      --accent: #f4c542;
      --accent-2: #e43f5a;
      --text-main: #ffffff;
      --text-muted: #c4d0dd;
      --door-bg: rgba(255, 255, 255, 0.06);
      --door-open-bg: rgba(255, 255, 255, 0.18);
      --today-glow: 0 0 12px rgba(244, 197, 66, 0.9);
      --border-radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #234567 0, #0b1b25 45%, #050910 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }

    .container {
      width: 100%;
      max-width: 960px;
      background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.12),
        rgba(255, 255, 255, 0.02)
      );
      border-radius: 24px;
      padding: 24px 20px 28px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 28px 60px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(18px);
    }

    @media (min-width: 768px) {
      .container { padding: 30px 32px 34px; }
    }

    /* little "snow" dots */
    .snow {
      pointer-events: none;
      position: absolute;
      inset: 0;
      opacity: 0.24;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.8) 1px, transparent 1px),
        radial-gradient(circle, rgba(255,255,255,0.5) 1px, transparent 1px);
      background-size: 120px 120px, 180px 180px;
      background-position: 0 0, 60px 60px;
      animation: snow-move 22s linear infinite;
    }

    @keyframes snow-move {
      0% { transform: translateY(-20px); }
      100% { transform: translateY(20px); }
    }

    .content {
      position: relative;
      z-index: 1;
    }

    h1 {
      margin: 0 0 4px;
      font-size: clamp(1.8rem, 3vw, 2.3rem);
      display: flex;
      align-items: center;
      gap: 0.4em;
      flex-wrap: wrap;
    }

    h1 span.emoji { font-size: 1.4em; }

    .subtitle {
      margin: 0 0 8px;
      color: var(--text-muted);
      font-size: 0.98rem;
    }

    #message {
      margin: 0 0 18px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .calendar-card {
      background: var(--bg-card);
      border-radius: var(--border-radius);
      padding: 18px 18px 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .calendar-header h2 {
      margin: 0;
      font-size: 1.02rem;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }

    .calendar-header span.sub {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .doors-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    @media (min-width: 600px) {
      .doors-grid { grid-template-columns: repeat(6, minmax(0, 1fr)); }
    }

    @media (min-width: 900px) {
      .doors-grid { grid-template-columns: repeat(8, minmax(0, 1fr)); }
    }

    .door {
      position: relative;
      border-radius: 12px;
      background: var(--door-bg);
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 10px 10px 12px;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s;
      cursor: pointer;
    }

    .door:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.5);
      background: rgba(255, 255, 255, 0.09);
    }

    .door-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .door-number {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .door-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .gift-number {
      margin-top: 4px;
      font-size: 1.6rem;
      font-weight: 700;
    }

    .door.opened {
      background: var(--door-open-bg);
      border-color: rgba(244, 197, 66, 0.7);
    }

    .door.opened .door-label { color: var(--accent); }

    .door.today { box-shadow: var(--today-glow); }

    .door-image {
      margin-top: 8px;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.3);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .door-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .footer-note {
      margin-top: 14px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    /* spin animation, used on gift number */
    .spin { animation: spin-bounce 0.7s ease-out; }

    @keyframes spin-bounce {
      0%   { transform: scale(1) rotate(0deg); }
      30%  { transform: scale(1.25) rotate(8deg); }
      60%  { transform: scale(1.25) rotate(-8deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    /* PASSWORD OVERLAY */
    #passwordOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #1c3550 0, #050910 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    #passwordOverlay.hidden { display: none; }

    .password-box {
      width: 100%;
      max-width: 380px;
      background: rgba(5, 10, 18, 0.9);
      border-radius: 18px;
      padding: 22px 20px 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.75);
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text-main);
    }

    .password-box h2 {
      margin: 0 0 8px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.4em;
    }

    .password-box p {
      margin: 0 0 14px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .password-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .password-row input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(3, 7, 15, 0.9);
      color: var(--text-main);
      font: inherit;
    }

    .password-row input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(244,197,66,0.4);
    }

    #passwordSubmit {
      padding: 8px 16px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f4c542, #f08c2e);
      color: #201001;
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    #passwordError {
      min-height: 1.1em;
      font-size: 0.8rem;
      color: #ff8787;
    }
  </style>
</head>
<body>
  <!-- PASSWORD OVERLAY -->
  <div id="passwordOverlay">
    <div class="password-box">
      <h2>ğŸ„ æ—¥å†å…¥å£</h2>
      <p>è¾“å…¥å¯†ç è§£é”æ—¥å†ã€‚</p>
      <form id="passwordForm">
        <div class="password-row">
          <input
            id="passwordInput"
            type="password"
            autocomplete="current-password"
            placeholder="å¯†ç "
            required
          />
          <button id="passwordSubmit" type="submit">è¿›å…¥</button>
        </div>
        <div id="passwordError"></div>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="container" id="appContainer" style="visibility:hidden;">
    <div class="snow"></div>
    <div class="content">
      <header>
        <h1>
          <span class="emoji">ğŸ„</span>
          åœ£è¯ç¤¼ç‰©æ—¥å†
        </h1>
        <p class="subtitle">
          ä» 12 æœˆ 1 æ—¥å¼€å§‹ï¼Œæ¯å¤©å¢åŠ  1 æ¬¡æœºä¼šã€‚ç‚¹å‡»ä»»æ„ä¸€æ‰‡é—¨æ¶ˆè€—ä¸€æ¬¡æœºä¼šã€‚æ¯æ‰‡æ‰“å¼€çš„é—¨éƒ½ä¼šæŠ½åˆ°ä¸€ä¸ª 1â€“24 çš„ç¤¼ç‰©å·ç ï¼Œæ¯ä¸ªå·ç åªä¼šç”¨ä¸€æ¬¡ã€‚
        </p>
        <p id="message"></p>
      </header>

      <section class="calendar-card" aria-label="Advent calendar doors">
        <div class="calendar-header">
          <h2>æ—¥å† <span>ğŸ—“ï¸</span></h2>
          <span class="sub">é—¨é‡Œæ˜¾ç¤ºçš„æ•°å­—å°±æ˜¯ä½ ä»Šå¤©çš„ç¤¼ç‰©ç¼–å·ã€‚</span>
        </div>
        <div id="doorsGrid" class="doors-grid"></div>
      </section>
    </div>
  </div>

  <script>
    // ========= SIMPLE CLIENT-SIDE PASSWORD =========
    // âš ï¸ è¿™åªæ˜¯ç®€å•é˜²å›å­ï¼Œä¸é˜²æŠ€æœ¯å…šã€‚
    const ADVENT_PASSWORD = "bobodan520"; // <-- æ”¹æˆä½ è‡ªå·±çš„å¯†ç 
    const STORAGE_AUTH_OK = "advent_auth_ok";

    const passwordOverlay = document.getElementById("passwordOverlay");
    const passwordForm = document.getElementById("passwordForm");
    const passwordInput = document.getElementById("passwordInput");
    const passwordError = document.getElementById("passwordError");
    const appContainer = document.getElementById("appContainer");

    // ========= ADVENT LOGIC =========
    const TOTAL_DOORS = 24;
    const STORAGE_ASSIGNMENTS = "advent_door_assignments"; // { doorIndex: giftNumber }

    const doorsGrid = document.getElementById("doorsGrid");
    const messageEl = document.getElementById("message");

    // Supported image extensions for each day
    const IMAGE_EXTS = ["png", "jpg", "jpeg", "webp", "gif"];

    let currentCredits = 0;
    let assignments = {}; // doorIndex -> giftNumber

    // ä»å½“å¹´ 12 æœˆ 1 æ—¥ç®—èµ·ï¼Œå¾—åˆ°å·²ç»â€œè§£é”â€çš„å¤©æ•°ï¼ˆä¸Šé™ 24ï¼‰
    function totalEarnedSpinsSoFar() {
      const now = new Date();
      const year = now.getFullYear();
      const start = new Date(year, 11, 1); // 11 = 12æœˆï¼ˆæœˆä»½ä» 0 å¼€å§‹ï¼‰

      if (now < start) return 0;

      const diffMs = now - start;
      const dayMs = 1000 * 60 * 60 * 24;
      const daysPassed = Math.floor(diffMs / dayMs) + 1; // åŒ…å« 12 æœˆ 1 æ—¥å½“å¤©
      return Math.min(TOTAL_DOORS, daysPassed);
    }

    function loadAssignments() {
      try {
        const raw = localStorage.getItem(STORAGE_ASSIGNMENTS);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : {};
      } catch (e) {
        return {};
      }
    }

    function saveAssignments(obj) {
      localStorage.setItem(STORAGE_ASSIGNMENTS, JSON.stringify(obj));
    }

    function getUsedGiftNumbers(assignmentsObj) {
      const used = new Set();
      for (const key in assignmentsObj) {
        if (Object.hasOwn(assignmentsObj, key)) {
          const val = assignmentsObj[key];
          if (typeof val === "number") used.add(val);
        }
      }
      return used;
    }

    // æ ¹æ®å½“å‰æ—¥æœŸå’Œå·²æ‰“å¼€çš„é—¨ï¼Œé‡æ–°è®¡ç®—å‰©ä½™æœºä¼š
    function recalcCredits() {
      const openedCount = Object.keys(assignments).length;
      const totalEarned = totalEarnedSpinsSoFar();
      const remainingDoors = Math.max(0, TOTAL_DOORS - openedCount);

      const rawCredits = totalEarned - openedCount;
      currentCredits = Math.max(0, Math.min(rawCredits, remainingDoors));
    }

    // Try to find an image for a given day with any of the supported extensions.
    function findImageForDay(day, callback) {
      let index = 0;

      function tryNext() {
        if (index >= IMAGE_EXTS.length) {
          callback(null);
          return;
        }
        const ext = IMAGE_EXTS[index++];
        const img = new Image();
        img.alt = "ç¬¬ " + day + " å¤©çš„æƒŠå–œ";
        img.onload = () => callback(img);
        img.onerror = tryNext;
        img.src = `images/day-${day}.${ext}`;
      }

      tryNext();
    }

    function updateMessage(credits, remainingDoors) {
      if (remainingDoors === 0) {
        messageEl.textContent = "è¿™å°è®¾å¤‡ä¸Šçš„ 24 æ‰‡é—¨å·²ç»å…¨éƒ¨æ‰“å¼€å•¦ã€‚";
        return;
      }

      if (credits > 0) {
        messageEl.textContent = `ä½ ç°åœ¨æœ‰ ${credits} æ¬¡æœºä¼šã€‚ç‚¹å‡»ä»»æ„ä¸€æ‰‡æœªæ‰“å¼€çš„é—¨æ¥æŠ½å–ç¤¼ç‰©å·ç ã€‚`;
      } else {
        messageEl.textContent =
          "ä»Šå¤©çš„æœºä¼šå·²ç»ç”¨å®Œå•¦ã€‚éšç€æ—¥æœŸå¾€åï¼Œæ¯å¤©éƒ½ä¼šå¢åŠ  1 æ¬¡æœºä¼šï¼ˆä¹‹å‰æ²¡ç”¨çš„ä¹Ÿä¼šç´¯ç§¯ï¼‰ã€‚";
      }
    }

    function renderDoors() {
      doorsGrid.innerHTML = "";
      const openedCount = Object.keys(assignments).length;
      const remainingDoors = TOTAL_DOORS - openedCount;

      for (let day = 1; day <= TOTAL_DOORS; day++) {
        const door = document.createElement("div");
        door.className = "door";

        const assignedGift = assignments[day];

        if (assignedGift != null) {
          door.classList.add("opened");
        }

        const header = document.createElement("div");
        header.className = "door-header";

        const dayEl = document.createElement("div");
        dayEl.className = "door-number";
        dayEl.textContent = day; // the day number

        const labelEl = document.createElement("div");
        labelEl.className = "door-label";
        labelEl.textContent =
          assignedGift != null ? `ç¤¼ç‰© #${assignedGift}` : "å°šæœªæ‰“å¼€";

        header.appendChild(dayEl);
        header.appendChild(labelEl);

        const giftNumberEl = document.createElement("div");
        giftNumberEl.className = "gift-number";
        giftNumberEl.textContent =
          assignedGift != null ? assignedGift : ""; // show big number only when opened

        const imageWrapper = document.createElement("div");
        imageWrapper.className = "door-image";
        imageWrapper.textContent = "æ·»åŠ  images/day-" + day + ".* å›¾ç‰‡";

        // Asynchronously try to load an image for this day
        findImageForDay(day, (img) => {
          if (img) {
            imageWrapper.textContent = "";
            imageWrapper.appendChild(img);
          }
        });

        door.appendChild(header);
        if (assignedGift != null) {
          door.appendChild(giftNumberEl);
        }
        door.appendChild(imageWrapper);

        // Door click handler (spend a spin, assign random gift number)
        door.addEventListener("click", () => {
          // If already opened, do nothing
          if (assignments[day] != null) {
            return;
          }

          // Use up-to-date remainingDoors when checking
          const openedNow = Object.keys(assignments).length;
          const remainingNow = TOTAL_DOORS - openedNow;

          if (currentCredits <= 0) {
            updateMessage(currentCredits, remainingNow);
            return;
          }

          const usedSet = getUsedGiftNumbers(assignments);
          const candidates = [];
          for (let gift = 1; gift <= TOTAL_DOORS; gift++) {
            if (!usedSet.has(gift)) {
              candidates.push(gift);
            }
          }

          if (candidates.length === 0) {
            updateMessage(currentCredits, 0);
            return;
          }

          const randomIndex = Math.floor(Math.random() * candidates.length);
          const chosenGift = candidates[randomIndex];

          // Assign and persist
          assignments[day] = chosenGift;
          saveAssignments(assignments);

          // Recalculate credits based on new state
          recalcCredits();

          // Update UI for this door
          door.classList.add("opened");
          labelEl.textContent = `ç¤¼ç‰© #${chosenGift}`;
          giftNumberEl.textContent = chosenGift;
          giftNumberEl.classList.add("spin");
          if (!door.contains(giftNumberEl)) {
            door.insertBefore(giftNumberEl, imageWrapper);
          }

          const openedAfter = Object.keys(assignments).length;
          const remainingAfter = TOTAL_DOORS - openedAfter;
          updateMessage(currentCredits, remainingAfter);
        });

        doorsGrid.appendChild(door);
      }

      updateMessage(currentCredits, remainingDoors);
    }

    function initAdvent() {
      assignments = loadAssignments();
      recalcCredits();
      renderDoors();
    }

    // ========= PASSWORD HANDLING =========
    function unlockApp() {
      passwordOverlay.classList.add("hidden");
      appContainer.style.visibility = "visible";
      initAdvent();
    }

    // If already authenticated in this browser, skip prompt
    if (localStorage.getItem(STORAGE_AUTH_OK) === "yes") {
      unlockApp();
    } else {
      appContainer.style.visibility = "hidden";
      passwordInput.focus();
    }

    passwordForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const entered = passwordInput.value;
      if (entered === ADVENT_PASSWORD) {
        localStorage.setItem(STORAGE_AUTH_OK, "yes");
        passwordError.textContent = "";
        unlockApp();
      } else {
        passwordError.textContent = "å¯†ç é”™è¯¯ã€‚";
        passwordInput.value = "";
        passwordInput.focus();
      }
    });
  </script>
</body>
</html>
